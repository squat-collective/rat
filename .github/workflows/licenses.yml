# RAT — Third-Party License Report
# Generates license notices for all dependencies across all packages.
# Runs weekly and on every release tag to keep reports fresh.

name: Licenses

on:
  schedule:
    - cron: "0 6 * * 1"  # Every Monday at 06:00 UTC
  push:
    tags: ["v*"]
  workflow_dispatch:  # Manual trigger

permissions:
  contents: read

jobs:
  generate:
    name: Generate License Reports
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # ── Go setup ──
      - uses: actions/setup-go@v5
        with:
          go-version: "1.24"
          cache-dependency-path: platform/go.sum

      - name: Install go-licenses
        run: go install github.com/google/go-licenses@latest

      # ── Python setup ──
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Python tools + deps
        run: |
          pip install --quiet pip-licenses
          cd runner && pip install --quiet -e . && cd ..
          cd query && pip install --quiet -e . && cd ..

      # ── Node setup ──
      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Node tools + deps
        run: |
          npm install -g license-checker
          cd sdk-typescript && npm ci && cd ..
          cd portal && npm ci && cd ..

      # ── Generate ──
      - name: Generate Go license report
        working-directory: platform
        run: |
          mkdir -p ../licenses
          {
            echo "# Third-Party Licenses — platform (ratd)"
            echo ""
            echo "| Module | License |"
            echo "|--------|---------|"
            go-licenses report ./... 2>/dev/null | sort | while IFS=',' read -r mod url license; do
              echo "| \`${mod}\` | ${license} |"
            done
          } > ../licenses/platform.md
          cp ../licenses/platform.md THIRD-PARTY-NOTICES.md

      - name: Generate Python license reports
        run: |
          for pkg_dir in runner query; do
            pkg_name="rat-${pkg_dir}"
            {
              echo "# Third-Party Licenses — ${pkg_name}"
              echo ""
              echo "| Package | Version | License |"
              echo "|---------|---------|---------|"
              cd "$pkg_dir"
              pip-licenses --format=json 2>/dev/null \
                | python3 -c "
          import json, sys
          data = json.load(sys.stdin)
          for pkg in sorted(data, key=lambda x: x['Name'].lower()):
              name = pkg['Name']
              version = pkg['Version']
              lic = pkg['License']
              if name.lower() in ('${pkg_name}', 'pip', 'setuptools', 'wheel', 'pip-licenses', 'prettytable', 'wcwidth'):
                  continue
              print(f'| \`{name}\` | {version} | {lic} |')
          " 2>/dev/null || echo "| _error generating_ | | |"
              cd ..
            } > "licenses/${pkg_dir}.md"
            cp "licenses/${pkg_dir}.md" "${pkg_dir}/THIRD-PARTY-NOTICES.md"
          done

      - name: Generate Node license reports
        run: |
          for pkg_dir in sdk-typescript portal; do
            pkg_name=$(node -p "require('./${pkg_dir}/package.json').name")
            {
              echo "# Third-Party Licenses — ${pkg_name}"
              echo ""
              echo "| Package | License |"
              echo "|---------|---------|"
              cd "$pkg_dir"
              license-checker --json --production 2>/dev/null \
                | python3 -c "
          import json, sys
          data = json.load(sys.stdin)
          for pkg_key in sorted(data.keys(), key=str.lower):
              info = data[pkg_key]
              lic = info.get('licenses', 'Unknown')
              print(f'| \`{pkg_key}\` | {lic} |')
          " 2>/dev/null || echo "| _error generating_ | |"
              cd ..
            } > "licenses/${pkg_dir}.md"
            cp "licenses/${pkg_dir}.md" "${pkg_dir}/THIRD-PARTY-NOTICES.md"
          done

      - name: Combine into root notice
        run: |
          {
            echo "# Third-Party Licenses"
            echo ""
            echo "> Auto-generated by CI — do not edit manually."
            echo "> Last updated: $(date -u +%Y-%m-%d)"
            echo ""
            echo "RAT is licensed under [AGPL-3.0](LICENSE). This file lists all"
            echo "third-party dependencies and their respective licenses."
            echo ""
            for report in licenses/*.md; do
              [ -f "$report" ] || continue
              echo "---"
              echo ""
              cat "$report"
              echo ""
            done
          } > THIRD-PARTY-NOTICES.md

      - name: Upload license reports
        uses: actions/upload-artifact@v4
        with:
          name: license-reports
          path: |
            THIRD-PARTY-NOTICES.md
            platform/THIRD-PARTY-NOTICES.md
            runner/THIRD-PARTY-NOTICES.md
            query/THIRD-PARTY-NOTICES.md
            portal/THIRD-PARTY-NOTICES.md
            sdk-typescript/THIRD-PARTY-NOTICES.md
          retention-days: 90
